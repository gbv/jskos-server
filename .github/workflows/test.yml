
name: Test

on: [push, pull_request]

jobs:
  test:

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [ 20.x, 22.x ]
        mongo-version: [4, 5, 6]

    services:
      mongodb:
        image: mongo:${{ matrix.mongo-version }}
        ports:
          - 27017:27017
        options: --replSet rs0 # pass `--replSet rs0` so changeStreams work

    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}


    # Wait a bit for Mongo to start in replSet mode, then initiate the set
    - name: Initiate MongoDB replica set
      run: |
        # use the mongo shell to initiate; retry until it succeeds
        until mongo --eval 'rs.initiate()'; do
          echo "Waiting for mongo to be readyâ€¦"
          sleep 1
        done
        
    - run: npm ci
    - run: npm test




    